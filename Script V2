local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local Teams = game:GetService("Teams")
local CoreGui = game:GetService("CoreGui")
local Workspace = game:GetService("Workspace")
local Lighting = game:GetService("Lighting")
local HttpService = game:GetService("HttpService")

local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera
local Mouse = LocalPlayer:GetMouse()
local Typing = false
local Running = false
local RequiredDistance = 2000
local Environment = nil

if FusePulseAimbot and FusePulseAimbot.Exit then
    FusePulseAimbot:Exit()
end

getgenv().FusePulseAimbot = {
    Settings = {
        Enabled = true,
        TeamCheck = true,
        AliveCheck = true,
        WallCheck = false,
        Sensitivity = 0,
        Sensitivity2 = 3.5,
        LockPart = "Head",
        TriggerKey = Enum.UserInputType.MouseButton2,
        Toggle = false,
        SelectedTeam = "All",
        AimAtSelectedTeam = true,
        ShootAtTeam = "Enemy", -- "Enemy", "Friendly", "All"
        AutoFire = false,
        AutoFireDelay = 0.2,
        AutoFireWallCheck = true
    },

    FOVSettings = {
        Enabled = true,
        Visible = true,
        Radius = 90,
        Thickness = 1,
        Color = Color3.fromRGB(255, 255, 255),
        OutlineColor = Color3.fromRGB(0, 0, 0),
        LockedColor = Color3.fromRGB(255, 150, 150)
    },

    ESPSettings = {
        Enabled = true,
        Box = true,
        BoxType = "Full", -- "Full", "Head"
        Tracer = true,
        Name = true,
        Distance = true,
        Health = true,
        BoxColor = Color3.fromRGB(0, 255, 0),
        TracerColor = Color3.fromRGB(255, 0, 0),
        TextColor = Color3.fromRGB(255, 255, 255),
        TextSize = 16,
        BoxThickness = 1,
        TracerThickness = 1,
        TeamColor = true,
        TextOutline = true
    },

    MovementSettings = {
        BunnyHop = false,
        BunnyHopKey = Enum.KeyCode.Space,
        AutoStrafe = false,
        SpeedBoost = false,
        SpeedMultiplier = 1.5,
        InfiniteJump = false,
        JumpHeight = 50,
        NoClip = false,
        NoClipSpeed = 2,
        Fly = false,
        FlySpeed = 2,
        FlyKey = Enum.KeyCode.F
    },

    VisualSettings = {
        SpinBot = false,
        SpinSpeed = 20,
        FOVChanger = false,
        FOVValue = 90,
        FullBright = false,
        TimeChanger = false,
        TimeValue = 12,
        NoFog = false
    },

    GUISettings = {
        Keybind = Enum.KeyCode.F2,
        Visible = true,
        Position = UDim2.new(0.5, -225, 0.5, -300),
        Size = UDim2.new(0, 450, 0, 550),
        Theme = "Dark",
        Watermark = true,
        Notifications = true
    },

    Blacklisted = {},
    TeamsList = {},
    GUI = nil,
    UIElements = {},
    FOVCircle = nil,
    FOVCircleOutline = nil,
    Locked = nil,
    ServiceConnections = {}
}

Environment = getgenv().FusePulseAimbot

-- Farbthemen
local Themes = {
    Dark = {
        Background = Color3.fromRGB(15, 15, 20),
        Secondary = Color3.fromRGB(25, 25, 35),
        Accent = Color3.fromRGB(220, 60, 60),
        Text = Color3.fromRGB(240, 240, 245),
        TextSecondary = Color3.fromRGB(180, 180, 190),
        Border = Color3.fromRGB(40, 40, 50),
        Success = Color3.fromRGB(0, 200, 80),
        Danger = Color3.fromRGB(220, 60, 60)
    }
}

local CurrentTheme = Themes[Environment.GUISettings.Theme] or Themes.Dark

-- Globale Variablen
local ESPCache = {}
local OriginalLightingSettings = {}
local NoClipConnection = nil
local FlyConnection = nil
local AutoFireConnection = nil
local TeamsCache = {}

local OriginalWalkSpeed = 16
local OriginalJumpPower = 50
local OriginalFOV = 70
local SpinAngle = 0
local IsFlying = false
local FlyBodyVelocity = nil
local FlyBodyGyro = nil

-- Notification System
local function SendNotification(title, message, duration)
    if not Environment.GUISettings.Notifications then return end
    print(string.format("[FusePulse] %s: %s", title, message))
end

-- Watermark
local Watermark = nil
local function CreateWatermark()
    if not Environment.GUISettings.Watermark then
        if Watermark then
            Watermark:Remove()
            Watermark = nil
        end
        return
    end
    
    if Watermark then Watermark:Remove() end
    
    Watermark = Drawing.new("Text")
    Watermark.Text = "FusePulse | " .. LocalPlayer.Name
    Watermark.Size = 16
    Watermark.Color = CurrentTheme.Accent
    Watermark.Outline = true
    Watermark.OutlineColor = Color3.fromRGB(0, 0, 0)
    Watermark.Visible = true
    Watermark.Center = false
    Watermark.Position = Vector2.new(10, 10)
end

-- FOV Circle
local function CreateFOVCircle()
    if Environment.FOVCircle then
        Environment.FOVCircle:Remove()
    end
    if Environment.FOVCircleOutline then
        Environment.FOVCircleOutline:Remove()
    end
    
    Environment.FOVCircle = Drawing.new("Circle")
    Environment.FOVCircleOutline = Drawing.new("Circle")
    
    Environment.FOVCircle.Visible = false
    Environment.FOVCircleOutline.Visible = false
    
    Environment.FOVCircle.Thickness = Environment.FOVSettings.Thickness
    Environment.FOVCircleOutline.Thickness = Environment.FOVSettings.Thickness + 2
    Environment.FOVCircle.Color = Environment.FOVSettings.Color
    Environment.FOVCircleOutline.Color = Environment.FOVSettings.OutlineColor
end

-- Wall Check für AutoFire
local function IsVisible(targetPosition)
    if not Environment.Settings.AutoFireWallCheck then
        return true
    end
    
    local character = LocalPlayer.Character
    if not character then return false end
    
    local head = character:FindFirstChild("Head")
    if not head then return false end
    
    local raycastParams = RaycastParams.new()
    raycastParams.FilterType = Enum.RaycastFilterType.Blacklist
    raycastParams.FilterDescendantsInstances = {character, Camera}
    raycastParams.IgnoreWater = true
    
    local direction = (targetPosition - head.Position).Unit
    local distance = (targetPosition - head.Position).Magnitude
    
    local raycastResult = Workspace:Raycast(head.Position, direction * distance, raycastParams)
    
    return raycastResult == nil
end

-- AutoFire System MIT ECHTEM MOUSE KLICK
local function SetupAutoFire()
    if AutoFireConnection then
        AutoFireConnection:Disconnect()
        AutoFireConnection = nil
    end
    
    if not Environment.Settings.AutoFire then return end
    
    local lastFireTime = 0
    local mouse = game:GetService("Players").LocalPlayer:GetMouse()
    
    AutoFireConnection = RunService.RenderStepped:Connect(function()
        if not Environment.Settings.AutoFire then return end
        if Typing then return end
        if not Running then return end
        
        local currentTime = tick()
        if currentTime - lastFireTime >= Environment.Settings.AutoFireDelay then
            if Environment.Locked then
                local character = Environment.Locked.Character
                if character then
                    local targetPart = character:FindFirstChild(Environment.Settings.LockPart)
                    if targetPart then
                        -- Wall Check
                        if IsVisible(targetPart.Position) then
                            -- Simulate actual mouse click
                            lastFireTime = currentTime
                            
                            -- Methode 1: Virtuelle MouseButton1Down/Up Events
                            if mouse then
                                -- Erstelle MouseButton1Down Event
                                local inputObject = Instance.new("InputObject")
                                inputObject.UserInputType = Enum.UserInputType.MouseButton1
                                inputObject.UserInputState = Enum.UserInputState.Begin
                                
                                -- Versuche den Mausklick zu simulieren
                                pcall(function()
                                    mouse.Button1Down:Fire()
                                    task.wait(0.05)
                                    mouse.Button1Up:Fire()
                                end)
                                
                                SendNotification("AutoFire", "Firing at target", 0.3)
                            end
                        else
                            SendNotification("AutoFire", "Target behind wall", 0.3)
                        end
                    end
                end
            end
        end
    end)
end

-- ESP System
local function CreateESP(player)
    if not player or not player.Character or ESPCache[player] then
        return
    end
    
    ESPCache[player] = {
        Box = Drawing.new("Square"),
        Tracer = Drawing.new("Line"),
        Name = Drawing.new("Text"),
        Distance = Drawing.new("Text"),
        Health = Drawing.new("Text")
    }
    
    local drawings = ESPCache[player]
    
    for _, drawing in pairs(drawings) do
        drawing.Visible = false
        if drawing.ClassName == "Text" then
            drawing.Outline = Environment.ESPSettings.TextOutline
            drawing.Center = true
        end
    end
end

local function RemoveESP(player)
    if ESPCache[player] then
        for _, drawing in pairs(ESPCache[player]) do
            if drawing and typeof(drawing) == "table" and drawing.Remove then
                drawing:Remove()
            end
        end
        ESPCache[player] = nil
    end
end

local function UpdateESP()
    if not Environment.ESPSettings.Enabled then
        for _, drawings in pairs(ESPCache) do
            for _, drawing in pairs(drawings) do
                drawing.Visible = false
            end
        end
        return
    end
    
    for player, drawings in pairs(ESPCache) do
        if not player or not player.Character then
            RemoveESP(player)
            continue
        end
        
        local character = player.Character
        local humanoid = character:FindFirstChildOfClass("Humanoid")
        local head = character:FindFirstChild("Head")
        
        if not character or not humanoid or not head or humanoid.Health <= 0 then
            for _, drawing in pairs(drawings) do
                drawing.Visible = false
            end
            continue
        end
        
        local headPos, onScreen = Camera:WorldToViewportPoint(head.Position)
        
        if not onScreen then
            for _, drawing in pairs(drawings) do
                drawing.Visible = false
            end
            continue
        end
        
        local color = Environment.ESPSettings.TeamColor and player.TeamColor.Color or Environment.ESPSettings.BoxColor
        local distance = (Camera.CFrame.Position - head.Position).Magnitude
        local scale = math.clamp(2000 / distance, 0.5, 2)
        
        if Environment.ESPSettings.Box then
            local size = Vector2.new(1500 / distance, 2000 / distance)
            drawings.Box.Visible = true
            drawings.Box.Color = color
            drawings.Box.Thickness = Environment.ESPSettings.BoxThickness
            drawings.Box.Filled = false
            drawings.Box.Size = size
            drawings.Box.Position = Vector2.new(headPos.X - size.X / 2, headPos.Y - size.Y / 2)
        else
            drawings.Box.Visible = false
        end
        
        if Environment.ESPSettings.Tracer then
            drawings.Tracer.Visible = true
            drawings.Tracer.Color = Environment.ESPSettings.TracerColor
            drawings.Tracer.Thickness = Environment.ESPSettings.TracerThickness
            drawings.Tracer.From = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y)
            drawings.Tracer.To = Vector2.new(headPos.X, headPos.Y)
        else
            drawings.Tracer.Visible = false
        end
        
        if Environment.ESPSettings.Name then
            drawings.Name.Visible = true
            drawings.Name.Color = Environment.ESPSettings.TextColor
            drawings.Name.Size = math.floor(Environment.ESPSettings.TextSize * scale)
            drawings.Name.Text = player.Name
            drawings.Name.Position = Vector2.new(headPos.X, headPos.Y - (30 * scale))
        else
            drawings.Name.Visible = false
        end
        
        if Environment.ESPSettings.Health then
            local health = humanoid.Health
            local maxHealth = humanoid.MaxHealth
            local healthPercent = math.floor((health / maxHealth) * 100)
            
            drawings.Health.Visible = true
            drawings.Health.Color = Color3.fromRGB(255 - (healthPercent * 2.55), healthPercent * 2.55, 0)
            drawings.Health.Size = math.floor(Environment.ESPSettings.TextSize * scale * 0.9)
            drawings.Health.Text = healthPercent .. "%"
            drawings.Health.Position = Vector2.new(headPos.X, headPos.Y - (50 * scale))
        else
            drawings.Health.Visible = false
        end
        
        if Environment.ESPSettings.Distance then
            drawings.Distance.Visible = true
            drawings.Distance.Color = Environment.ESPSettings.TextColor
            drawings.Distance.Size = math.floor(Environment.ESPSettings.TextSize * scale * 0.9)
            drawings.Distance.Text = math.floor(distance) .. "m"
            drawings.Distance.Position = Vector2.new(headPos.X, headPos.Y + (25 * scale))
        else
            drawings.Distance.Visible = false
        end
    end
end

-- Movement Functions
local function SetupBunnyHop()
    local character = LocalPlayer.Character
    if not character then return end
    
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    if not humanoid then return end
    
    if humanoid.FloorMaterial ~= Enum.Material.Air then
        humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
    end
end

local function ApplySpeedBoost()
    local character = LocalPlayer.Character
    if not character then return end
    
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    if not humanoid then return end
    
    humanoid.WalkSpeed = OriginalWalkSpeed * Environment.MovementSettings.SpeedMultiplier
end

local function ResetSpeed()
    local character = LocalPlayer.Character
    if not character then return end
    
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    if not humanoid then return end
    
    humanoid.WalkSpeed = OriginalWalkSpeed
end

-- Fly System GEFIXT
local function SetupFly()
    if FlyConnection then
        FlyConnection:Disconnect()
        FlyConnection = nil
    end
    
    if FlyBodyVelocity then
        FlyBodyVelocity:Destroy()
        FlyBodyVelocity = nil
    end
    
    if FlyBodyGyro then
        FlyBodyGyro:Destroy()
        FlyBodyGyro = nil
    end
    
    if not Environment.MovementSettings.Fly then
        IsFlying = false
        return
    end
    
    IsFlying = true
    
    FlyConnection = RunService.Heartbeat:Connect(function()
        if not Environment.MovementSettings.Fly or not IsFlying then
            return
        end
        
        local character = LocalPlayer.Character
        if not character then return end
        
        local root = character:FindFirstChild("HumanoidRootPart")
        if not root then return end
        
        -- Erstelle BodyVelocity und BodyGyro für stabiles Fliegen
        if not FlyBodyVelocity then
            FlyBodyVelocity = Instance.new("BodyVelocity")
            FlyBodyVelocity.MaxForce = Vector3.new(10000, 10000, 10000)
            FlyBodyVelocity.P = 10000
            FlyBodyVelocity.Velocity = Vector3.new(0, 0, 0)
            FlyBodyVelocity.Parent = root
        end
        
        if not FlyBodyGyro then
            FlyBodyGyro = Instance.new("BodyGyro")
            FlyBodyGyro.MaxTorque = Vector3.new(10000, 10000, 10000)
            FlyBodyGyro.P = 10000
            FlyBodyGyro.D = 500
            FlyBodyGyro.CFrame = root.CFrame
            FlyBodyGyro.Parent = root
        end
        
        -- Bewegung basierend auf Tasten
        local moveDirection = Vector3.new(0, 0, 0)
        local speed = Environment.MovementSettings.FlySpeed
        
        if UserInputService:IsKeyDown(Enum.KeyCode.W) then
            moveDirection = moveDirection + Camera.CFrame.LookVector
        end
        if UserInputService:IsKeyDown(Enum.KeyCode.S) then
            moveDirection = moveDirection - Camera.CFrame.LookVector
        end
        if UserInputService:IsKeyDown(Enum.KeyCode.A) then
            moveDirection = moveDirection - Camera.CFrame.RightVector
        end
        if UserInputService:IsKeyDown(Enum.KeyCode.D) then
            moveDirection = moveDirection + Camera.CFrame.RightVector
        end
        if UserInputService:IsKeyDown(Enum.KeyCode.Space) then
            moveDirection = moveDirection + Vector3.new(0, 1, 0)
        end
        if UserInputService:IsKeyDown(Enum.KeyCode.LeftShift) then
            moveDirection = moveDirection - Vector3.new(0, 1, 0)
        end
        
        if moveDirection.Magnitude > 0 then
            moveDirection = moveDirection.Unit * speed
            FlyBodyVelocity.Velocity = moveDirection
        else
            FlyBodyVelocity.Velocity = Vector3.new(0, 0, 0)
        end
        
        -- Halte die Rotation stabil
        FlyBodyGyro.CFrame = Camera.CFrame
    end)
end

-- Visual Functions
local function ApplySpinBot()
    local character = LocalPlayer.Character
    if not character then return end
    
    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then return end
    
    SpinAngle = (SpinAngle + Environment.VisualSettings.SpinSpeed) % 360
    humanoidRootPart.CFrame = humanoidRootPart.CFrame * CFrame.Angles(0, math.rad(SpinAngle), 0)
end

local function ApplyFOVChanger()
    Camera.FieldOfView = Environment.VisualSettings.FOVValue
end

local function ResetFOV()
    Camera.FieldOfView = OriginalFOV
end

-- FullBright
local function SetupFullBright()
    if Environment.VisualSettings.FullBright then
        OriginalLightingSettings.Ambient = Lighting.Ambient
        OriginalLightingSettings.Brightness = Lighting.Brightness
        OriginalLightingSettings.GlobalShadows = Lighting.GlobalShadows
        
        Lighting.Ambient = Color3.new(1, 1, 1)
        Lighting.Brightness = 2
        Lighting.GlobalShadows = false
        Lighting.OutdoorAmbient = Color3.new(1, 1, 1)
        
        if Environment.VisualSettings.NoFog then
            OriginalLightingSettings.FogEnd = Lighting.FogEnd
            Lighting.FogEnd = 100000
        end
    else
        if OriginalLightingSettings.Ambient then
            Lighting.Ambient = OriginalLightingSettings.Ambient
            Lighting.Brightness = OriginalLightingSettings.Brightness
            Lighting.GlobalShadows = OriginalLightingSettings.GlobalShadows
        end
        if OriginalLightingSettings.FogEnd then
            Lighting.FogEnd = OriginalLightingSettings.FogEnd
        end
    end
end

-- NoClip
local function SetupNoClip()
    if NoClipConnection then
        NoClipConnection:Disconnect()
        NoClipConnection = nil
    end
    
    if not Environment.MovementSettings.NoClip then return end
    
    NoClipConnection = RunService.Stepped:Connect(function()
        if not Environment.MovementSettings.NoClip then return end
        if not LocalPlayer.Character then return end
        
        local character = LocalPlayer.Character
        for _, part in pairs(character:GetDescendants()) do
            if part:IsA("BasePart") then
                part.CanCollide = false
            end
        end
    end)
end

-- Time Changer
local function SetupTimeChanger()
    if Environment.VisualSettings.TimeChanger then
        Lighting.ClockTime = Environment.VisualSettings.TimeValue
    end
end

-- Team Auswahl Funktionen
local function GetTeamOptions()
    local options = {"All"}
    
    for _, team in pairs(Teams:GetTeams()) do
        table.insert(options, team.Name)
        TeamsCache[team.Name] = team
    end
    
    return options
end

-- Aimbot Functions mit Team-Auswahl
local function ShouldTargetPlayer(player)
    if player == LocalPlayer then return false end
    
    local localTeam = LocalPlayer.Team
    local playerTeam = player.Team
    local shootAtTeam = Environment.Settings.ShootAtTeam
    
    if shootAtTeam == "All" then
        return true
    elseif shootAtTeam == "Enemy" then
        return playerTeam ~= localTeam
    elseif shootAtTeam == "Friendly" then
        return playerTeam == localTeam
    end
    
    return true
end

local function GetClosestPlayer()
    if not Environment.Settings.Enabled then return end
    
    local LockPart = Environment.Settings.LockPart
    RequiredDistance = Environment.FOVSettings.Enabled and Environment.FOVSettings.Radius or 2000
    
    if not Environment.Locked then
        for _, player in pairs(Players:GetPlayers()) do
            if not ShouldTargetPlayer(player) then continue end
            
            local character = player.Character
            if not character then continue end
            
            local targetPart = character:FindFirstChild(LockPart)
            local humanoid = character:FindFirstChildOfClass("Humanoid")
            
            if not targetPart or not humanoid or humanoid.Health <= 0 then continue end
            
            if Environment.Settings.TeamCheck then
                local playerTeam = player.Team
                local localTeam = LocalPlayer.Team
                
                if Environment.Settings.AimAtSelectedTeam and Environment.Settings.SelectedTeam ~= "All" then
                    local selectedTeam = TeamsCache[Environment.Settings.SelectedTeam]
                    if playerTeam ~= selectedTeam then
                        continue
                    end
                elseif playerTeam == localTeam then
                    continue
                end
            end
            
            local screenPos, onScreen = Camera:WorldToViewportPoint(targetPart.Position)
            
            if onScreen then
                local mousePos = UserInputService:GetMouseLocation()
                local distance = (Vector2.new(screenPos.X, screenPos.Y) - mousePos).Magnitude
                
                if distance < RequiredDistance then
                    RequiredDistance = distance
                    Environment.Locked = player
                end
            end
        end
    end
end

local function CancelLock()
    Environment.Locked = nil
    if Environment.FOVCircle then
        Environment.FOVCircle.Color = Environment.FOVSettings.Color
    end
end

-- Typing Check
local function SetupTypingCheck()
    Environment.ServiceConnections.TypingStarted = UserInputService.TextBoxFocused:Connect(function()
        Typing = true
    end)
    
    Environment.ServiceConnections.TypingEnded = UserInputService.TextBoxFocusReleased:Connect(function()
        Typing = false
    end)
end

-- Player Tracking
local function SetupPlayerTracking()
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            CreateESP(player)
        end
    end
    
    Environment.ServiceConnections.PlayerAdded = Players.PlayerAdded:Connect(function(player)
        CreateESP(player)
    end)
    
    Environment.ServiceConnections.PlayerRemoving = Players.PlayerRemoving:Connect(function(player)
        RemoveESP(player)
    end)
end

-- UI Element Funktionen
local function CreateToggle(parent, text, defaultValue, callback)
    local ToggleFrame = Instance.new("Frame")
    ToggleFrame.Name = text .. "Toggle"
    ToggleFrame.Size = UDim2.new(1, -10, 0, 36)
    ToggleFrame.BackgroundTransparency = 1
    ToggleFrame.Parent = parent
    
    local ToggleLabel = Instance.new("TextLabel")
    ToggleLabel.Name = "Label"
    ToggleLabel.Size = UDim2.new(0.7, -10, 1, 0)
    ToggleLabel.Position = UDim2.new(0, 10, 0, 0)
    ToggleLabel.BackgroundTransparency = 1
    ToggleLabel.Text = text
    ToggleLabel.TextColor3 = CurrentTheme.Text
    ToggleLabel.TextSize = 14
    ToggleLabel.Font = Enum.Font.Gotham
    ToggleLabel.TextXAlignment = Enum.TextXAlignment.Left
    ToggleLabel.Parent = ToggleFrame
    
    local ToggleContainer = Instance.new("Frame")
    ToggleContainer.Name = "Container"
    ToggleContainer.Size = UDim2.new(0, 50, 0, 26)
    ToggleContainer.Position = UDim2.new(1, -60, 0.5, -13)
    ToggleContainer.BackgroundColor3 = CurrentTheme.Secondary
    ToggleContainer.BackgroundTransparency = 0
    ToggleContainer.Parent = ToggleFrame
    
    local ContainerCorner = Instance.new("UICorner")
    ContainerCorner.CornerRadius = UDim.new(1, 0)
    ContainerCorner.Parent = ToggleContainer
    
    local ToggleKnob = Instance.new("Frame")
    ToggleKnob.Name = "Knob"
    ToggleKnob.Size = UDim2.new(0, 22, 0, 22)
    ToggleKnob.Position = defaultValue and UDim2.new(1, -24, 0.5, -11) or UDim2.new(0, 2, 0.5, -11)
    ToggleKnob.BackgroundColor3 = defaultValue and CurrentTheme.Success or CurrentTheme.Danger
    ToggleKnob.BackgroundTransparency = 0
    ToggleKnob.Parent = ToggleContainer
    
    local KnobCorner = Instance.new("UICorner")
    KnobCorner.CornerRadius = UDim.new(1, 0)
    KnobCorner.Parent = ToggleKnob
    
    local ToggleButton = Instance.new("TextButton")
    ToggleButton.Name = "Button"
    ToggleButton.Size = UDim2.new(1, 0, 1, 0)
    ToggleButton.BackgroundTransparency = 1
    ToggleButton.Text = ""
    ToggleButton.Parent = ToggleContainer
    
    local function UpdateToggle(value)
        defaultValue = value
        local targetPosition = value and UDim2.new(1, -24, 0.5, -11) or UDim2.new(0, 2, 0.5, -11)
        local targetColor = value and CurrentTheme.Success or CurrentTheme.Danger
        
        TweenService:Create(ToggleKnob, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
            Position = targetPosition,
            BackgroundColor3 = targetColor
        }):Play()
        
        if callback then callback(value) end
    end
    
    ToggleButton.MouseButton1Click:Connect(function()
        UpdateToggle(not defaultValue)
    end)
    
    UpdateToggle(defaultValue)
    
    return ToggleFrame
end

local function CreateDropdown(parent, text, defaultValue, options, callback)
    local DropdownFrame = Instance.new("Frame")
    DropdownFrame.Name = text .. "Dropdown"
    DropdownFrame.Size = UDim2.new(1, -10, 0, 36)
    DropdownFrame.BackgroundTransparency = 1
    DropdownFrame.Parent = parent
    
    local DropdownLabel = Instance.new("TextLabel")
    DropdownLabel.Name = "Label"
    DropdownLabel.Size = UDim2.new(0.6, -10, 1, 0)
    DropdownLabel.Position = UDim2.new(0, 10, 0, 0)
    DropdownLabel.BackgroundTransparency = 1
    DropdownLabel.Text = text
    DropdownLabel.TextColor3 = CurrentTheme.Text
    DropdownLabel.TextSize = 14
    DropdownLabel.Font = Enum.Font.Gotham
    DropdownLabel.TextXAlignment = Enum.TextXAlignment.Left
    DropdownLabel.Parent = DropdownFrame
    
    local DropdownButton = Instance.new("TextButton")
    DropdownButton.Name = "Button"
    DropdownButton.Size = UDim2.new(0, 120, 0, 30)
    DropdownButton.Position = UDim2.new(1, -130, 0.5, -15)
    DropdownButton.BackgroundColor3 = CurrentTheme.Secondary
    DropdownButton.BackgroundTransparency = 0
    DropdownButton.Text = defaultValue
    DropdownButton.TextColor3 = CurrentTheme.Text
    DropdownButton.TextSize = 12
    DropdownButton.Font = Enum.Font.Gotham
    DropdownButton.AutoButtonColor = false
    DropdownButton.Parent = DropdownFrame
    
    local ButtonCorner = Instance.new("UICorner")
    ButtonCorner.CornerRadius = UDim.new(0, 6)
    ButtonCorner.Parent = DropdownButton
    
    local currentIndex = table.find(options, defaultValue) or 1
    
    DropdownButton.MouseButton1Click:Connect(function()
        currentIndex = (currentIndex % #options) + 1
        local newValue = options[currentIndex]
        DropdownButton.Text = newValue
        if callback then callback(newValue) end
    end)
    
    return DropdownFrame
end

local function CreateSlider(parent, text, defaultValue, min, max, step, callback)
    local SliderFrame = Instance.new("Frame")
    SliderFrame.Name = text .. "Slider"
    SliderFrame.Size = UDim2.new(1, -10, 0, 50)
    SliderFrame.BackgroundTransparency = 1
    SliderFrame.Parent = parent
    
    local SliderLabel = Instance.new("TextLabel")
    SliderLabel.Name = "Label"
    SliderLabel.Size = UDim2.new(1, -70, 0, 20)
    SliderLabel.Position = UDim2.new(0, 10, 0, 0)
    SliderLabel.BackgroundTransparency = 1
    SliderLabel.Text = text
    SliderLabel.TextColor3 = CurrentTheme.Text
    SliderLabel.TextSize = 14
    SliderLabel.Font = Enum.Font.Gotham
    SliderLabel.TextXAlignment = Enum.TextXAlignment.Left
    SliderLabel.Parent = SliderFrame
    
    local ValueLabel = Instance.new("TextLabel")
    ValueLabel.Name = "Value"
    ValueLabel.Size = UDim2.new(0, 60, 0, 20)
    ValueLabel.Position = UDim2.new(1, -70, 0, 0)
    ValueLabel.BackgroundTransparency = 1
    ValueLabel.Text = tostring(defaultValue)
    ValueLabel.TextColor3 = CurrentTheme.Accent
    ValueLabel.TextSize = 14
    ValueLabel.Font = Enum.Font.GothamBold
    ValueLabel.TextXAlignment = Enum.TextXAlignment.Right
    ValueLabel.Parent = SliderFrame
    
    local SliderTrack = Instance.new("Frame")
    SliderTrack.Name = "Track"
    SliderTrack.Size = UDim2.new(1, -20, 0, 6)
    SliderTrack.Position = UDim2.new(0, 10, 0, 30)
    SliderTrack.BackgroundColor3 = CurrentTheme.Secondary
    SliderTrack.BackgroundTransparency = 0
    SliderTrack.Parent = SliderFrame
    
    local TrackCorner = Instance.new("UICorner")
    TrackCorner.CornerRadius = UDim.new(1, 0)
    TrackCorner.Parent = SliderTrack
    
    local SliderFill = Instance.new("Frame")
    SliderFill.Name = "Fill"
    SliderFill.Size = UDim2.new((defaultValue - min) / (max - min), 0, 1, 0)
    SliderFill.Position = UDim2.new(0, 0, 0, 0)
    SliderFill.BackgroundColor3 = CurrentTheme.Accent
    SliderFill.BackgroundTransparency = 0
    SliderFill.Parent = SliderTrack
    
    local FillCorner = Instance.new("UICorner")
    FillCorner.CornerRadius = UDim.new(1, 0)
    FillCorner.Parent = SliderFill
    
    local currentValue = defaultValue
    local dragging = false
    
    local function UpdateSlider(value)
        value = math.clamp(value, min, max)
        value = math.floor(value / step) * step
        currentValue = value
        
        local fillSize = (value - min) / (max - min)
        
        TweenService:Create(SliderFill, TweenInfo.new(0.1, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
            Size = UDim2.new(fillSize, 0, 1, 0)
        }):Play()
        
        ValueLabel.Text = tostring(value)
        
        if callback then callback(value) end
    end
    
    local function onInputBegan(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            
            local mousePos = UserInputService:GetMouseLocation()
            local trackPos = SliderTrack.AbsolutePosition
            local trackSize = SliderTrack.AbsoluteSize
            
            local relativeX = math.clamp((mousePos.X - trackPos.X) / trackSize.X, 0, 1)
            local value = min + (max - min) * relativeX
            
            UpdateSlider(value)
        end
    end
    
    local function onInputChanged(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local mousePos = input.Position
            local trackPos = SliderTrack.AbsolutePosition
            local trackSize = SliderTrack.AbsoluteSize
            
            local relativeX = math.clamp((mousePos.X - trackPos.X) / trackSize.X, 0, 1)
            local value = min + (max - min) * relativeX
            
            UpdateSlider(value)
        end
    end
    
    local function onInputEnded(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
        end
    end
    
    SliderTrack.InputBegan:Connect(onInputBegan)
    UserInputService.InputChanged:Connect(onInputChanged)
    UserInputService.InputEnded:Connect(onInputEnded)
    
    return SliderFrame
end

-- GUI Erstellung
local function CreateGUI()
    if Environment.GUI then
        Environment.GUI:Destroy()
        Environment.UIElements = {}
    end
    
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "FusePulseGUI"
    ScreenGui.ResetOnSpawn = false
    ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    ScreenGui.DisplayOrder = 999
    ScreenGui.Parent = CoreGui
    
    local MainContainer = Instance.new("Frame")
    MainContainer.Name = "MainContainer"
    MainContainer.Size = Environment.GUISettings.Size
    MainContainer.Position = Environment.GUISettings.Position
    MainContainer.BackgroundColor3 = CurrentTheme.Background
    MainContainer.BackgroundTransparency = 0
    MainContainer.BorderSizePixel = 0
    MainContainer.ClipsDescendants = true
    MainContainer.Visible = Environment.GUISettings.Visible
    MainContainer.Parent = ScreenGui
    
    local MainCorner = Instance.new("UICorner")
    MainCorner.CornerRadius = UDim.new(0, 12)
    MainCorner.Parent = MainContainer
    
    -- Header
    local Header = Instance.new("Frame")
    Header.Name = "Header"
    Header.Size = UDim2.new(1, 0, 0, 50)
    Header.BackgroundColor3 = CurrentTheme.Secondary
    Header.BackgroundTransparency = 0
    Header.BorderSizePixel = 0
    Header.Parent = MainContainer
    
    local HeaderCorner = Instance.new("UICorner")
    HeaderCorner.CornerRadius = UDim.new(0, 12)
    HeaderCorner.Parent = Header
    
    local Title = Instance.new("TextLabel")
    Title.Name = "Title"
    Title.Size = UDim2.new(0.6, 0, 1, 0)
    Title.Position = UDim2.new(0, 15, 0, 0)
    Title.BackgroundTransparency = 1
    Title.Text = "FUSEPULSE V2"
    Title.TextColor3 = CurrentTheme.Accent
    Title.TextSize = 20
    Title.Font = Enum.Font.GothamBold
    Title.TextXAlignment = Enum.TextXAlignment.Left
    Title.Parent = Header
    
    local CloseButton = Instance.new("TextButton")
    CloseButton.Name = "CloseButton"
    CloseButton.Size = UDim2.new(0, 40, 0, 40)
    CloseButton.Position = UDim2.new(1, -50, 0.5, -20)
    CloseButton.BackgroundColor3 = CurrentTheme.Danger
    CloseButton.Text = "✕"
    CloseButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    CloseButton.TextSize = 18
    CloseButton.Font = Enum.Font.GothamBold
    CloseButton.Parent = Header
    
    local CloseCorner = Instance.new("UICorner")
    CloseCorner.CornerRadius = UDim.new(0, 8)
    CloseCorner.Parent = CloseButton
    
    local UnloadButton = Instance.new("TextButton")
    UnloadButton.Name = "UnloadButton"
    UnloadButton.Size = UDim2.new(0, 80, 0, 30)
    UnloadButton.Position = UDim2.new(1, -140, 0.5, -15)
    UnloadButton.BackgroundColor3 = CurrentTheme.Accent
    UnloadButton.Text = "UNLOAD"
    UnloadButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    UnloadButton.TextSize = 12
    UnloadButton.Font = Enum.Font.GothamBold
    UnloadButton.Parent = Header
    
    local UnloadCorner = Instance.new("UICorner")
    UnloadCorner.CornerRadius = UDim.new(0, 6)
    UnloadCorner.Parent = UnloadButton
    
    -- Tabs
    local TabContainer = Instance.new("Frame")
    TabContainer.Name = "TabContainer"
    TabContainer.Size = UDim2.new(1, -20, 0, 36)
    TabContainer.Position = UDim2.new(0, 10, 0, 60)
    TabContainer.BackgroundTransparency = 1
    TabContainer.Parent = MainContainer
    
    local TabList = Instance.new("UIListLayout")
    TabList.FillDirection = Enum.FillDirection.Horizontal
    TabList.SortOrder = Enum.SortOrder.LayoutOrder
    TabList.Padding = UDim.new(0, 8)
    TabList.Parent = TabContainer
    
    local TabNames = {"AIMBOT", "ESP", "MOVEMENT", "VISUAL"}
    local TabButtons = {}
    
    for i, tabName in ipairs(TabNames) do
        local TabButton = Instance.new("TextButton")
        TabButton.Name = tabName .. "Tab"
        TabButton.Size = UDim2.new(0, 100, 1, 0)
        TabButton.BackgroundColor3 = i == 1 and CurrentTheme.Accent or CurrentTheme.Secondary
        TabButton.BackgroundTransparency = 0
        TabButton.Text = tabName
        TabButton.TextColor3 = i == 1 and Color3.fromRGB(255, 255, 255) or CurrentTheme.Text
        TabButton.TextSize = 12
        TabButton.Font = Enum.Font.GothamSemibold
        TabButton.AutoButtonColor = false
        TabButton.Parent = TabContainer
        
        local TabCorner = Instance.new("UICorner")
        TabCorner.CornerRadius = UDim.new(0, 6)
        TabCorner.Parent = TabButton
        
        TabButtons[tabName] = TabButton
    end
    
    -- Content Area
    local ContentContainer = Instance.new("Frame")
    ContentContainer.Name = "ContentContainer"
    ContentContainer.Size = UDim2.new(1, -20, 1, -110)
    ContentContainer.Position = UDim2.new(0, 10, 0, 106)
    ContentContainer.BackgroundTransparency = 1
    ContentContainer.ClipsDescendants = true
    ContentContainer.Parent = MainContainer
    
    -- Tab Contents
    local TabContents = {}
    
    for _, tabName in ipairs(TabNames) do
        local TabContent = Instance.new("ScrollingFrame")
        TabContent.Name = tabName .. "Content"
        TabContent.Size = UDim2.new(1, 0, 1, 0)
        TabContent.BackgroundTransparency = 1
        TabContent.Visible = tabName == "AIMBOT"
        TabContent.ScrollBarThickness = 4
        TabContent.ScrollBarImageColor3 = CurrentTheme.Border
        TabContent.AutomaticCanvasSize = Enum.AutomaticSize.Y
        TabContent.CanvasSize = UDim2.new(0, 0, 0, 0)
        TabContent.Parent = ContentContainer
        
        local TabLayout = Instance.new("UIListLayout")
        TabLayout.SortOrder = Enum.SortOrder.LayoutOrder
        TabLayout.Padding = UDim.new(0, 8)
        TabLayout.Parent = TabContent
        
        TabContents[tabName] = TabContent
    end
    
    -- Get actual team options
    local teamOptions = GetTeamOptions()
    
    -- Aimbot Tab
    CreateToggle(TabContents["AIMBOT"], "Enabled", Environment.Settings.Enabled, function(value)
        Environment.Settings.Enabled = value
        SendNotification("Aimbot", value and "Enabled" or "Disabled", 1)
    end).LayoutOrder = 1
    
    CreateToggle(TabContents["AIMBOT"], "Team Check", Environment.Settings.TeamCheck, function(value)
        Environment.Settings.TeamCheck = value
    end).LayoutOrder = 2
    
    CreateDropdown(TabContents["AIMBOT"], "Shoot At", Environment.Settings.ShootAtTeam, 
        {"Enemy", "Friendly", "All"}, function(value)
        Environment.Settings.ShootAtTeam = value
        SendNotification("Aimbot", "Shooting at: " .. value, 1)
    end).LayoutOrder = 3
    
    -- Team selection with actual teams
    CreateDropdown(TabContents["AIMBOT"], "Select Team", Environment.Settings.SelectedTeam, 
        teamOptions, function(value)
        Environment.Settings.SelectedTeam = value
        SendNotification("Aimbot", "Selected team: " .. value, 1)
    end).LayoutOrder = 4
    
    CreateToggle(TabContents["AIMBOT"], "Auto Fire", Environment.Settings.AutoFire, function(value)
        Environment.Settings.AutoFire = value
        SetupAutoFire()
        SendNotification("AutoFire", value and "Enabled" or "Disabled", 1)
    end).LayoutOrder = 5
    
    CreateToggle(TabContents["AIMBOT"], "Wall Check", Environment.Settings.AutoFireWallCheck, function(value)
        Environment.Settings.AutoFireWallCheck = value
    end).LayoutOrder = 6
    
    CreateSlider(TabContents["AIMBOT"], "Fire Delay", Environment.Settings.AutoFireDelay, 0.05, 1, 0.05, function(value)
        Environment.Settings.AutoFireDelay = value
    end).LayoutOrder = 7
    
    CreateToggle(TabContents["AIMBOT"], "FOV Circle", Environment.FOVSettings.Enabled, function(value)
        Environment.FOVSettings.Enabled = value
    end).LayoutOrder = 8
    
    CreateSlider(TabContents["AIMBOT"], "FOV Radius", Environment.FOVSettings.Radius, 10, 300, 5, function(value)
        Environment.FOVSettings.Radius = value
    end).LayoutOrder = 9
    
    -- ESP Tab
    CreateToggle(TabContents["ESP"], "ESP Enabled", Environment.ESPSettings.Enabled, function(value)
        Environment.ESPSettings.Enabled = value
        SendNotification("ESP", value and "Enabled" or "Disabled", 1)
    end).LayoutOrder = 1
    
    CreateToggle(TabContents["ESP"], "Team Color", Environment.ESPSettings.TeamColor, function(value)
        Environment.ESPSettings.TeamColor = value
    end).LayoutOrder = 2
    
    CreateToggle(TabContents["ESP"], "Box ESP", Environment.ESPSettings.Box, function(value)
        Environment.ESPSettings.Box = value
    end).LayoutOrder = 3
    
    CreateToggle(TabContents["ESP"], "Tracer", Environment.ESPSettings.Tracer, function(value)
        Environment.ESPSettings.Tracer = value
    end).LayoutOrder = 4
    
    CreateToggle(TabContents["ESP"], "Show Name", Environment.ESPSettings.Name, function(value)
        Environment.ESPSettings.Name = value
    end).LayoutOrder = 5
    
    CreateToggle(TabContents["ESP"], "Show Health", Environment.ESPSettings.Health, function(value)
        Environment.ESPSettings.Health = value
    end).LayoutOrder = 6
    
    CreateToggle(TabContents["ESP"], "Show Distance", Environment.ESPSettings.Distance, function(value)
        Environment.ESPSettings.Distance = value
    end).LayoutOrder = 7
    
    -- Movement Tab
    CreateToggle(TabContents["MOVEMENT"], "Bunny Hop", Environment.MovementSettings.BunnyHop, function(value)
        Environment.MovementSettings.BunnyHop = value
    end).LayoutOrder = 1
    
    CreateToggle(TabContents["MOVEMENT"], "Speed Boost", Environment.MovementSettings.SpeedBoost, function(value)
        Environment.MovementSettings.SpeedBoost = value
        if value then
            ApplySpeedBoost()
        else
            ResetSpeed()
        end
    end).LayoutOrder = 2
    
    CreateSlider(TabContents["MOVEMENT"], "Speed Multiplier", Environment.MovementSettings.SpeedMultiplier, 1, 5, 0.1, function(value)
        Environment.MovementSettings.SpeedMultiplier = value
        if Environment.MovementSettings.SpeedBoost then
            ApplySpeedBoost()
        end
    end).LayoutOrder = 3
    
    CreateToggle(TabContents["MOVEMENT"], "Fly (F Key)", Environment.MovementSettings.Fly, function(value)
        Environment.MovementSettings.Fly = value
        SetupFly()
        SendNotification("Fly", value and "Enabled (Press F)" or "Disabled", 1)
    end).LayoutOrder = 4
    
    CreateSlider(TabContents["MOVEMENT"], "Fly Speed", Environment.MovementSettings.FlySpeed, 1, 10, 0.5, function(value)
        Environment.MovementSettings.FlySpeed = value
    end).LayoutOrder = 5
    
    CreateToggle(TabContents["MOVEMENT"], "NoClip", Environment.MovementSettings.NoClip, function(value)
        Environment.MovementSettings.NoClip = value
        SetupNoClip()
    end).LayoutOrder = 6
    
    -- Visual Tab
    CreateToggle(TabContents["VISUAL"], "Spin Bot", Environment.VisualSettings.SpinBot, function(value)
        Environment.VisualSettings.SpinBot = value
    end).LayoutOrder = 1
    
    CreateToggle(TabContents["VISUAL"], "FullBright", Environment.VisualSettings.FullBright, function(value)
        Environment.VisualSettings.FullBright = value
        SetupFullBright()
        SendNotification("FullBright", value and "Enabled" or "Disabled", 1)
    end).LayoutOrder = 2
    
    CreateToggle(TabContents["VISUAL"], "FOV Changer", Environment.VisualSettings.FOVChanger, function(value)
        Environment.VisualSettings.FOVChanger = value
        if value then
            ApplyFOVChanger()
        else
            ResetFOV()
        end
    end).LayoutOrder = 3
    
    CreateSlider(TabContents["VISUAL"], "FOV Value", Environment.VisualSettings.FOVValue, 30, 120, 5, function(value)
        Environment.VisualSettings.FOVValue = value
        if Environment.VisualSettings.FOVChanger then
            ApplyFOVChanger()
        end
    end).LayoutOrder = 4
    
    CreateToggle(TabContents["VISUAL"], "Time Changer", Environment.VisualSettings.TimeChanger, function(value)
        Environment.VisualSettings.TimeChanger = value
        SetupTimeChanger()
    end).LayoutOrder = 5
    
    -- Tab Switching
    for tabName, button in pairs(TabButtons) do
        button.MouseButton1Click:Connect(function()
            for name, content in pairs(TabContents) do
                content.Visible = name == tabName
            end
            
            for name, btn in pairs(TabButtons) do
                local isActive = name == tabName
                btn.BackgroundColor3 = isActive and CurrentTheme.Accent or CurrentTheme.Secondary
                btn.TextColor3 = isActive and Color3.fromRGB(255, 255, 255) or CurrentTheme.Text
            end
        end)
    end
    
    -- Button Events
    CloseButton.MouseButton1Click:Connect(function()
        Environment.GUISettings.Visible = false
        MainContainer.Visible = false
        SendNotification("GUI", "Closed", 1)
    end)
    
    UnloadButton.MouseButton1Click:Connect(function()
        Environment:Exit()
        SendNotification("FusePulse", "Script unloaded", 2)
    end)
    
    -- Drag & Drop
    local dragging = false
    local dragInput
    local dragStart
    local startPos
    
    local function update(input)
        local delta = input.Position - dragStart
        local newPos = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        MainContainer.Position = newPos
        Environment.GUISettings.Position = newPos
    end
    
    Header.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = MainContainer.Position
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    
    Header.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            dragInput = input
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            update(input)
        end
    end)
    
    Environment.GUI = ScreenGui
end

-- Main Loop
local function MainLoop()
    -- FOV Circle
    if Environment.FOVCircle and Environment.FOVSettings.Enabled and Environment.Settings.Enabled then
        Environment.FOVCircle.Visible = true
        Environment.FOVCircleOutline.Visible = true
        
        Environment.FOVCircle.Radius = Environment.FOVSettings.Radius
        Environment.FOVCircleOutline.Radius = Environment.FOVSettings.Radius + 2
        
        local mousePos = UserInputService:GetMouseLocation()
        Environment.FOVCircle.Position = mousePos
        Environment.FOVCircleOutline.Position = mousePos
        
        Environment.FOVCircle.Color = Environment.Locked and Environment.FOVSettings.LockedColor or Environment.FOVSettings.Color
    else
        if Environment.FOVCircle then
            Environment.FOVCircle.Visible = false
            Environment.FOVCircleOutline.Visible = false
        end
    end
    
    -- ESP Update
    UpdateESP()
    
    -- Aimbot
    if Running and Environment.Settings.Enabled then
        GetClosestPlayer()
        
        if Environment.Locked then
            local character = Environment.Locked.Character
            if character then
                local targetPart = character:FindFirstChild(Environment.Settings.LockPart)
                if targetPart then
                    Camera.CFrame = CFrame.new(Camera.CFrame.Position, targetPart.Position)
                end
            end
        end
    end
    
    -- Visual Effects
    if Environment.VisualSettings.SpinBot then
        ApplySpinBot()
    end
    
    if Environment.VisualSettings.FOVChanger then
        ApplyFOVChanger()
    end
    
    if Environment.VisualSettings.TimeChanger then
        Lighting.ClockTime = Environment.VisualSettings.TimeValue
    end
    
    -- Movement
    if Environment.MovementSettings.BunnyHop then
        SetupBunnyHop()
    end
    
    if Environment.MovementSettings.SpeedBoost then
        ApplySpeedBoost()
    end
end

-- Keybinds Setup
local function SetupKeybinds()
    Environment.ServiceConnections.KeybindConnection = UserInputService.InputBegan:Connect(function(input)
        -- F2 GUI Toggle
        if input.KeyCode == Environment.GUISettings.Keybind then
            Environment.GUISettings.Visible = not Environment.GUISettings.Visible
            if Environment.GUI then
                Environment.GUI.MainContainer.Visible = Environment.GUISettings.Visible
            end
            SendNotification("GUI", "GUI " .. (Environment.GUISettings.Visible and "opened" or "closed"), 1)
        end
        
        -- Fly Key
        if input.KeyCode == Environment.MovementSettings.FlyKey then
            if Environment.MovementSettings.Fly then
                IsFlying = not IsFlying
                SendNotification("Fly", IsFlying and "Fly enabled" or "Fly disabled", 1)
            end
        end
        
        -- Trigger Key
        if not Typing then
            local TriggerKey = Environment.Settings.TriggerKey
            if input.UserInputType == TriggerKey then
                if Environment.Settings.Toggle then
                    Running = not Running
                    if not Running then
                        CancelLock()
                    end
                    SendNotification("Aimbot", "Aimbot " .. (Running and "ON" or "OFF"), 1)
                else
                    Running = true
                end
            end
        end
    end)
    
    Environment.ServiceConnections.KeybindEnded = UserInputService.InputEnded:Connect(function(input)
        if not Environment.Settings.Toggle and not Typing then
            local TriggerKey = Environment.Settings.TriggerKey
            if input.UserInputType == TriggerKey then
                Running = false
                CancelLock()
            end
        end
    end)
end

-- Load Funktion
local function Load()
    SendNotification("FusePulse", "Premium Combat System Loaded", 3)
    
    CreateFOVCircle()
    CreateWatermark()
    CreateGUI()
    
    SetupKeybinds()
    SetupTypingCheck()
    SetupPlayerTracking()
    SetupFullBright()
    SetupTimeChanger()
    SetupAutoFire()
    SetupFly()
    
    Environment.ServiceConnections.RenderStepped = RunService.RenderStepped:Connect(MainLoop)
end

-- Exit/Unload Funktion
function Environment.Exit(self)
    SendNotification("FusePulse", "Unloading script...", 2)
    
    -- Alle Connections trennen
    for _, connection in pairs(Environment.ServiceConnections) do
        pcall(function() connection:Disconnect() end)
    end
    
    -- Features zurücksetzen
    if NoClipConnection then pcall(function() NoClipConnection:Disconnect() end) end
    if FlyConnection then pcall(function() FlyConnection:Disconnect() end) end
    if AutoFireConnection then pcall(function() AutoFireConnection:Disconnect() end) end
    
    -- Fly Objekte entfernen
    if FlyBodyVelocity then
        pcall(function() FlyBodyVelocity:Destroy() end)
        FlyBodyVelocity = nil
    end
    
    if FlyBodyGyro then
        pcall(function() FlyBodyGyro:Destroy() end)
        FlyBodyGyro = nil
    end
    
    -- ESP entfernen
    for player, _ in pairs(ESPCache) do
        RemoveESP(player)
    end
    
    -- GUI entfernen
    if Environment.GUI then
        pcall(function() Environment.GUI:Destroy() end)
    end
    
    -- Watermark entfernen
    if Watermark then
        pcall(function() Watermark:Remove() end)
    end
    
    -- Drawing Objekte entfernen
    if Environment.FOVCircle then
        pcall(function() Environment.FOVCircle:Remove() end)
    end
    if Environment.FOVCircleOutline then
        pcall(function() Environment.FOVCircleOutline:Remove() end)
    end
    
    -- Lighting zurücksetzen
    SetupFullBright()
    
    -- Movement zurücksetzen
    ResetSpeed()
    ResetFOV()
    
    getgenv().FusePulseAimbot = nil
    
    SendNotification("FusePulse", "Script successfully unloaded", 2)
end

function Environment.ToggleGUI()
    Environment.GUISettings.Visible = not Environment.GUISettings.Visible
    if Environment.GUI then
        Environment.GUI.MainContainer.Visible = Environment.GUISettings.Visible
    end
end

Load()

return Environment
